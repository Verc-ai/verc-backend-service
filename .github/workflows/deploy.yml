name: Deploy
run-name: Deploy to ${{ github.event_name == 'push' && 'staging' || inputs.environment }}

on:
  workflow_dispatch:
    inputs:
      environment:
        type: environment
        required: true
        default: staging

  # Automatic staging deployment on push to main
  push:
    branches:
      - main

permissions:
  contents: write
  id-token: write

env:
  GCP_REGION: us-east4
  WORKLOAD_IDENTITY_PROVIDER: projects/391319920980/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  SERVICE_ACCOUNT: github-ci@verc-staging.iam.gserviceaccount.com

  # Cloud Run services
  STAGING_PROJECT: verc-staging
  PROD_PROJECT: verc-prod
  STAGING_SERVICE: verc-app-staging
  PROD_SERVICE: verc-app-prod

  # Artifact Registry Repos
  STAGING_REPO: verc-app-staging
  PROD_REPO: verc-app-prod

jobs:
  setup-build-publish:
    runs-on: ubuntu-latest

    # Determine environment:
    # push → staging
    # manual → inputs.environment
    environment: ${{ github.event_name == 'push' && 'staging' || inputs.environment }}

    outputs:
      image_path: ${{ steps.build-image.outputs.image_path }}
      deploy_env: ${{ steps.env-select.outputs.deploy_env }}
      service_name: ${{ steps.env-select.outputs.service_name }}
      project_id: ${{ steps.env-select.outputs.project_id }}
      repository: ${{ steps.env-select.outputs.repository }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      ###############################################################
      # 0. SELECT ENVIRONMENT + SERVICES + REPOS
      ###############################################################
      - name: Select Environment
        id: env-select
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "deploy_env=staging" >> $GITHUB_OUTPUT
            echo "service_name=${{ env.STAGING_SERVICE }}" >> $GITHUB_OUTPUT
            echo "project_id=${{ env.STAGING_PROJECT }}" >> $GITHUB_OUTPUT
            echo "repository=${{ env.STAGING_REPO }}" >> $GITHUB_OUTPUT
          else
            if [ "${{ inputs.environment }}" = "production" ]; then
              echo "deploy_env=production" >> $GITHUB_OUTPUT
              echo "service_name=${{ env.PROD_SERVICE }}" >> $GITHUB_OUTPUT
              echo "project_id=${{ env.PROD_PROJECT }}" >> $GITHUB_OUTPUT
              echo "repository=${{ env.PROD_REPO }}" >> $GITHUB_OUTPUT
            else
              echo "deploy_env=staging" >> $GITHUB_OUTPUT
              echo "service_name=${{ env.STAGING_SERVICE }}" >> $GITHUB_OUTPUT
              echo "project_id=${{ env.STAGING_PROJECT }}" >> $GITHUB_OUTPUT
              echo "repository=${{ env.STAGING_REPO }}" >> $GITHUB_OUTPUT
            fi
          fi

      ###############################################################
      # 1. AUTHENTICATE TO GOOGLE CLOUD
      ###############################################################
      - uses: google-github-actions/auth@v2
        id: auth
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Configure Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      ###############################################################
      # 2. BUILD + PUSH DOCKER IMAGE
      ###############################################################
      - name: Build Docker Image
        id: build-image
        run: |
          IMAGE_PATH="${{ env.GCP_REGION }}-docker.pkg.dev/${{ steps.env-select.outputs.project_id }}/${{ steps.env-select.outputs.repository }}/django-backend:${{ github.sha }}"
          echo "Building image: $IMAGE_PATH"

          docker build --platform linux/amd64 -t $IMAGE_PATH .
          docker push $IMAGE_PATH

          echo "image_path=$IMAGE_PATH" >> $GITHUB_OUTPUT

  ###################################################################
  # 3. DEPLOY TO CLOUD RUN
  ###################################################################
  deploy:
    needs: setup-build-publish
    runs-on: ubuntu-latest
    environment: ${{ needs.setup-build-publish.outputs.deploy_env }}

    steps:
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        id: deploy-backend
        run: |
          SERVICE="${{ needs.setup-build-publish.outputs.service_name }}"
          PROJECT="${{ needs.setup-build-publish.outputs.project_id }}"

          # Previous URL (if exists)
          SERVICE_URL=$(gcloud run services describe "$SERVICE" \
            --region ${{ env.GCP_REGION }} \
            --project "$PROJECT" \
            --format 'value(status.url)' 2>/dev/null || echo "")

          echo "Deploying to service: $SERVICE in project: $PROJECT"

          gcloud run deploy "$SERVICE" \
            --image "${{ needs.setup-build-publish.outputs.image_path }}" \
            --region "${{ env.GCP_REGION }}" \
            --platform managed \
            --allow-unauthenticated \
            --service-account "391319920980-compute@developer.gserviceaccount.com" \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 5 \
            --concurrency 80 \
            --timeout 300 \
            --set-env-vars "NODE_ENV=production,ENVIRONMENT=${{ needs.setup-build-publish.outputs.deploy_env }},GCP_PROJECT_ID=$PROJECT,GCP_REGION=${{ env.GCP_REGION }},CLOUD_RUN_SERVICE_URL=$SERVICE_URL" \
            --set-secrets "SUPABASE_URL=supabase-url:latest,SUPABASE_ANON_KEY=supabase-anon-key:latest,SUPABASE_SERVICE_ROLE_KEY=supabase-service-role-key:latest,OPENAI_API_KEY=openai-api-key:latest,ANTHROPIC_API_KEY=anthropic-api-key:latest,ASSEMBLYAI_API_KEY=assemblyai-api-key:latest,TWILIO_ACCOUNT_SID=twilio-account-sid:latest,TWILIO_AUTH_TOKEN=twilio-auth-token:latest,TWILIO_PHONE_NUMBER=twilio-phone-number:latest,TWILIO_WEBHOOK_BASE_URL=TWILIO_WEBHOOK_BASE_URL:latest"

          # Get updated URL
          URL=$(gcloud run services describe "$SERVICE" \
            --region ${{ env.GCP_REGION }} \
            --project "$PROJECT" \
            --format 'value(status.url)')

          echo "Backend deployed to: $URL"
          echo "url=$URL" >> $GITHUB_OUTPUT

      ###################################################################
      # 4. HEALTH CHECK
      ###################################################################
      - name: Health Check
        run: |
          URL="${{ steps.deploy-backend.outputs.url }}"
          echo "Checking health at $URL/health"
          if curl -s -f "$URL/health" >/dev/null; then
            echo "✅ Health check passed"
          else
            echo "❌ Health check FAILED"
            exit 1
          fi

      ###################################################################
      # 5. SUMMARY
      ###################################################################
      - name: Summary
        run: |
          echo "=================================================="
          echo "Deployment Complete"
          echo "Environment:  ${{ needs.setup-build-publish.outputs.deploy_env }}"
          echo "Service:      ${{ needs.setup-build-publish.outputs.service_name }}"
          echo "Backend URL:  ${{ steps.deploy-backend.outputs.url }}"
          echo "=================================================="
