name: Deploy Staging

on:
  # Only run after CI workflow completes successfully
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main
  # Allow manual trigger
  workflow_dispatch:

env:
  GCP_PROJECT_ID: verc-staging
  GCP_REGION: us-east4
  WORKLOAD_IDENTITY_PROVIDER: projects/391319920980/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  SERVICE_ACCOUNT: github-ci@verc-staging.iam.gserviceaccount.com
  TF_VERSION: "1.6.0"

permissions:
  contents: read
  id-token: write

jobs:
  # Check that CI passed before deploying
  check-ci-success:
    name: Verify CI Success
    runs-on: ubuntu-latest
    # Skip this check for manual triggers
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    steps:
      - name: CI Success Check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "⚠️  Manual deployment triggered - skipping CI check"
            echo "Make sure CI has passed before deploying!"
          else
            echo "✅ CI workflow passed successfully"
            echo "Proceeding with deployment..."
          fi

  deploy:
    needs: check-ci-success
    name: Build and Deploy
    runs-on: ubuntu-latest
    # needs: test  # Uncomment when tests are added
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and Push Image
        run: |
          IMAGE="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/verc-app-staging/django-backend:${{ github.sha }}"
          docker build --platform linux/amd64 -t $IMAGE .
          docker push $IMAGE

      - name: Deploy to Cloud Run
        id: deploy-backend
        run: |
          SERVICE_NAME="verc-app-staging"
          SERVICE_URL=$(gcloud run services describe "${SERVICE_NAME}" --region "${{ env.GCP_REGION }}" --format 'value(status.url)' 2>/dev/null || echo "")
          
          gcloud run deploy "${SERVICE_NAME}" \
            --image "${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/verc-app-staging/django-backend:${{ github.sha }}" \
            --region "${{ env.GCP_REGION }}" \
            --platform managed \
            --allow-unauthenticated \
            --service-account "391319920980-compute@developer.gserviceaccount.com" \
            --set-env-vars "NODE_ENV=production,ENVIRONMENT=staging,GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }},GCP_REGION=${{ env.GCP_REGION }},GCP_TASK_QUEUE_NAME=transcription-queue-staging-v2,CLOUD_TASKS_ENABLED=true,CLOUD_TASKS_SERVICE_ACCOUNT_EMAIL=cloud-tasks-invoker@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com,ASSEMBLYAI_PII_REDACTION_ENABLED=true,ASSEMBLYAI_PII_SUBSTITUTION=entity_name,ASSEMBLYAI_GENERATE_REDACTED_AUDIO=true,DJANGO_ENV=production,CLOUD_RUN_SERVICE_URL=${SERVICE_URL}" \
            --set-secrets "SUPABASE_URL=supabase-url:latest,SUPABASE_ANON_KEY=supabase-anon-key:latest,SUPABASE_SERVICE_ROLE_KEY=supabase-service-role-key:latest,OPENAI_API_KEY=openai-api-key:latest,ANTHROPIC_API_KEY=anthropic-api-key:latest,ASSEMBLYAI_API_KEY=assemblyai-api-key:latest,TWILIO_ACCOUNT_SID=twilio-account-sid:latest,TWILIO_AUTH_TOKEN=twilio-auth-token:latest,TWILIO_PHONE_NUMBER=twilio-phone-number:latest,TWILIO_WEBHOOK_BASE_URL=TWILIO_WEBHOOK_BASE_URL:latest" \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 5 \
            --concurrency 80 \
            --timeout 300 \
            --quiet
          
          # Get the actual service URL after deployment
          BACKEND_URL=$(gcloud run services describe "${SERVICE_NAME}" --region "${{ env.GCP_REGION }}" --format 'value(status.url)')
          echo "Backend deployed to: $BACKEND_URL"
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT

      - name: Test Backend Health
        run: |
          BACKEND_URL="${{ steps.deploy-backend.outputs.url }}"
          if curl -s -f "${BACKEND_URL}/health" > /dev/null; then
            echo "✅ Health check passed"
          else
            echo "❌ Health check failed"
            exit 1
          fi

      - name: Show Deployment Summary
        run: |
          echo "=================================================="
          echo "Staging Deployment Complete"
          echo "=================================================="
          echo "Backend URL:  ${{ steps.deploy-backend.outputs.url }}"
          echo "=================================================="