name: Deploy Staging

on:
  # Only run after CI workflow completes successfully
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main
  # Allow manual trigger
  workflow_dispatch:

env:
  GCP_PROJECT_ID: verc-staging
  GCP_REGION: us-east4
  WORKLOAD_IDENTITY_PROVIDER: projects/391319920980/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  SERVICE_ACCOUNT: github-ci@verc-staging.iam.gserviceaccount.com
  TF_VERSION: "1.6.0"

permissions:
  contents: read
  id-token: write

jobs:
  # Check that CI passed before deploying
  check-ci-success:
    name: Verify CI Success
    runs-on: ubuntu-latest
    # Skip this check for manual triggers
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    steps:
      - name: CI Success Check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "⚠️  Manual deployment triggered - skipping CI check"
            echo "Make sure CI has passed before deploying!"
          else
            echo "✅ CI workflow passed successfully"
            echo "Proceeding with deployment..."
          fi

  deploy:
    needs: check-ci-success
    name: Build and Deploy
    runs-on: ubuntu-latest
    # needs: test  # Uncomment when tests are added
    defaults:
      run:
        working-directory: infra/envs/staging
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and Push Image
        working-directory: backend
        run: |
          IMAGE="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/verc-app-staging/app:${{ github.sha }}"
          docker build -t $IMAGE .
          docker push $IMAGE

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        run: terraform apply -auto-approve -var="image_tag=${{ github.sha }}"

      - name: Cleanup Terraform Lock on Failure
        if: failure() || cancelled()
        run: |
          LOCK_FILE="gs://tf-state-verc/staging/default.tflock"
          if gcloud storage ls $LOCK_FILE 2>/dev/null; then
            echo "Removing stale lock file..."
            gcloud storage rm $LOCK_FILE
          fi

      - name: Show Cloud Run URL
        id: backend-url
        run: |
          BACKEND_URL=$(terraform output -raw cloud_run_url)
          echo "Backend deployed to: $BACKEND_URL"
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache global npm packages
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-global-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-global-

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment
        working-directory: frontend
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build Frontend
        working-directory: frontend
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VITE_API_URL: ${{ steps.backend-url.outputs.url }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Deploy to Vercel
        id: vercel-deploy
        working-directory: frontend
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "Frontend deployed to: $DEPLOYMENT_URL"
          echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Show Deployment Summary
        run: |
          echo "=================================================="
          echo "Staging Deployment Complete"
          echo "=================================================="
          echo "Backend URL:  ${{ steps.backend-url.outputs.url }}"
          echo "Frontend URL: ${{ steps.vercel-deploy.outputs.url }}"
          echo "=================================================="